<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Farm HPU2Süå∑</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 1. SETUP GIAO DI·ªÜN --- */
        :root {
            --primary-color: #ff8fa3; 
            --bg-color: #ffe3e8;      
            --glass-bg: rgba(255, 255, 255, 0.95);
            --text-color: #5d5d5d;
            --danger: #ff4757;
            --success: #2ed573;
            --base-font-size: 15px; 
            --bottom-nav-height: 70px;
        }

        body.dark-mode {
            --bg-color: #2f3640;
            --glass-bg: rgba(47, 54, 64, 0.95);
            --text-color: #f5f6fa;
            --primary-color: #a29bfe;
        }

        body.font-small { --base-font-size: 13px; }
        body.font-large { --base-font-size: 17px; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Quicksand', sans-serif; transition: all 0.3s; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            height: 100vh;
            color: var(--text-color);
            font-size: var(--base-font-size);
        }

        /* --- UI CHUNG --- */
        .genz-input {
            width: 100%; padding: 12px 15px; border-radius: 20px;
            border: 1px solid #ddd; background: #f9f9f9; outline: none; 
            font-size: var(--base-font-size); margin-top: 5px;
        }
        .genz-input:focus { border-color: var(--primary-color); background: white; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { font-size: 0.9em; font-weight: bold; margin-left: 10px; color: var(--primary-color); }
        .btn-submit { background: var(--primary-color); color: white; border: none; padding: 12px; width: 100%; border-radius: 50px; font-weight: bold; font-size: 1.1em; margin-top: 10px; cursor: pointer; }
        .hidden { display: none !important; }

        /* --- M√ÄN H√åNH ƒêƒÇNG K√ù/NH·∫¨P --- */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; flex-direction: column; padding: 20px; overflow-y: auto;
        }
        .auth-card {
            background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 30px;
            box-shadow: 0 10px 30px rgba(255, 143, 163, 0.3); text-align: center;
            width: 100%; max-width: 400px; border: 2px solid white; margin: auto;
        }
        .btn-link { background: none; border: none; color: var(--primary-color); text-decoration: underline; cursor: pointer; margin-top: 15px; }
        .location-wrapper { position: relative; }
        .btn-loc-icon { position: absolute; right: 10px; top: 55%; transform: translateY(-50%); background: none; border: none; color: var(--primary-color); font-size: 18px; padding: 5px; cursor: pointer;}

        /* --- DASHBOARD --- */
        #main-app { display: none; height: 100%; width: 100%; }
        #main-app.active { display: flex; }

        .sidebar {
            width: 260px; background: var(--glass-bg); padding: 20px;
            border-right: 1px solid rgba(255,255,255,0.5); display: flex; flex-direction: column;
            height: 100vh; position: sticky; top: 0;
        }
        .menu li {
            list-style: none; padding: 15px; margin: 10px 0; border-radius: 15px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px; white-space: nowrap;
        }
        .menu li.active, .menu li:hover { background: var(--primary-color); color: white; }
        .user-footer { margin-top: auto; display: flex; align-items: center; gap: 10px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 15px; }

        .main-content { flex: 1; padding: 20px; overflow-y: auto; height: 100vh; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .grid-box { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        .card { background: var(--glass-bg); border-radius: 20px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }

        /* CAMERA & OSD */
        .video-box { height: 300px; background: #000; border-radius: 15px; position: relative; overflow: hidden; }
        .video-box video, .video-box img { width: 100%; height: 100%; object-fit: cover; }
        .live-tag { position: absolute; top: 15px; right: 15px; background: red; color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; display: none; font-weight: bold; animation: pulse 1.5s infinite; }
        
        .camera-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 15px; color: white;
            display: flex; flex-direction: column; gap: 5px;
            text-shadow: 1px 1px 2px black; font-size: 0.9em;
        }
        .overlay-row { display: flex; align-items: center; gap: 8px; }
        .overlay-row i { width: 20px; text-align: center; color: var(--primary-color); }

        /* B√ÅO C√ÅO */
        .alert-box { background: #dff9fb; color: #0abde3; padding: 15px; border-radius: 10px; margin-top: 10px; font-weight: bold; display: flex; align-items: center; gap: 10px;}
        .alert-box.danger { background: #ffdad9; color: #eb4d4b; border: 1px solid red; animation: shake 0.5s; }
        .health-list { list-style: none; margin-top: 15px; font-size: 0.95em; }
        .health-list li { margin-bottom: 8px; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 5px; display: flex; justify-content: space-between;}
        .health-list b { color: var(--text-color); }
        .health-list span { font-weight: bold; color: var(--primary-color); }

        /* C√ÄI ƒê·∫∂T (GRID G·ªåN G√ÄNG) */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-top: 15px; }
        .profile-card-setting { grid-column: 1 / -1; background: var(--glass-bg); border-radius: 20px; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .setting-box { background: var(--glass-bg); border-radius: 18px; padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .setting-box:hover { border-color: var(--primary-color); transform: translateY(-3px); }
        .setting-icon { font-size: 1.4em; color: var(--primary-color); background: rgba(255, 143, 163, 0.1); padding: 10px; border-radius: 50%; }
        .setting-label { font-size: 0.85em; font-weight: bold; margin-bottom: 2px; }
        .genz-select { padding: 4px; border-radius: 8px; border: 1px solid #ddd; width: 100%; text-align: center; font-size: 0.85em; }
        .genz-toggle { width: 18px; height: 18px; accent-color: var(--primary-color); cursor: pointer; }
        .color-picker-wrapper { width: 100%; height: 30px; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; cursor: pointer;}
        .color-picker-wrapper input { width: 150%; height: 150%; transform: translate(-10%, -10%); cursor: pointer; border: none; }
        .btn-edit-mini { background: #eee; border: none; padding: 5px 10px; border-radius: 10px; cursor: pointer; font-size: 0.8em; }

        /* MODAL */
        #edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 25px; width: 90%; max-width: 350px; animation: zoomIn 0.3s; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
        @keyframes zoomIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            #main-app.active { flex-direction: column; }
            .sidebar {
                position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height);
                flex-direction: row; padding: 5px 15px; border-right: none;
                border-top: 1px solid rgba(255,255,255,0.5); z-index: 1000; justify-content: space-between; background: rgba(255, 255, 255, 0.98);
            }
            .sidebar h2, .user-footer { display: none; }
            .menu { display: flex; width: 100%; justify-content: space-around; padding: 0; }
            .menu li { flex-direction: column; padding: 8px 5px; margin: 0; font-size: 0.8em; gap: 5px; text-align: center; flex: 1; }
            .menu li i { font-size: 1.4em; }
            .main-content { padding: 15px; padding-bottom: calc(var(--bottom-nav-height) + 20px); height: auto; }
            .grid-box { grid-template-columns: 1fr; gap: 15px; }
            .settings-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body class="font-medium">

    <div id="auth-screen">
        <div id="register-form" class="auth-card">
            <h2 style="color: var(--primary-color);">üåª ƒêƒÉng K√Ω HPU2S Farm</h2>
            <form onsubmit="handleRegister(event)">
                <div class="input-group"><label>H·ªç v√† T√™n</label><input type="text" id="reg-name" class="genz-input" required></div>
                <div class="input-group"><label>SƒêT/Email (T√†i kho·∫£n)</label><input type="text" id="reg-contact" class="genz-input" required></div>
                <div class="input-group"><label>M·∫≠t kh·∫©u</label><input type="password" id="reg-pass" class="genz-input" required></div>
                <div class="input-group"><label>Ng√†y sinh</label><input type="date" id="reg-dob" class="genz-input" required></div>
                
                <div class="input-group">
                    <label>V·ªã tr√≠ v∆∞·ªùn (Hi·ªÉn th·ªã tr√™n Camera)</label>
                    <div class="location-wrapper">
                        <input type="text" id="reg-loc" class="genz-input" placeholder="VD: V∆∞·ªùn S√¢n Th∆∞·ª£ng" required>
                        <button type="button" class="btn-loc-icon" onclick="autoGetLocation()"><i class="fa-solid fa-location-crosshairs"></i></button>
                    </div>
                </div>

                <button type="submit" class="btn-submit">ƒêƒÉng K√Ω ‚ú®</button>
                <button type="button" class="btn-link" onclick="toggleAuthMode('login')">ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</button>
            </form>
        </div>
        <div id="login-form" class="auth-card hidden">
            <h2 style="color: var(--primary-color);">üîê ƒêƒÉng Nh·∫≠p</h2>
            <form onsubmit="handleLogin(event)">
                <div class="input-group"><label>SƒêT/Email</label><input type="text" id="login-contact" class="genz-input" required></div>
                <div class="input-group"><label>M·∫≠t kh·∫©u</label><input type="password" id="login-pass" class="genz-input" required></div>
                <button type="submit" class="btn-submit">V√†o Ngay üîì</button>
                <button type="button" class="btn-link" onclick="toggleAuthMode('register')">ƒêƒÉng k√Ω m·ªõi</button>
            </form>
        </div>
    </div>

    <div id="main-app">
        <aside class="sidebar">
            <h2 style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">üå± HPU2S Farm </h2>
            <ul class="menu">
                <li class="active" onclick="switchTab('dashboard', this)"><i class="fa-solid fa-chart-pie"></i> <span>T·ªïng quan</span></li>
                <li onclick="switchTab('notifications', this)"><i class="fa-solid fa-bell"></i> <span>Th√¥ng b√°o</span></li>
                <li onclick="switchTab('settings', this)"><i class="fa-solid fa-grid-2"></i> <span>C√†i ƒë·∫∑t</span></li>
            </ul>
            <div class="user-footer">
                <img src="" id="sidebar-avatar" style="width: 35px; border-radius: 50%;">
                <div style="overflow: hidden;">
                    <p style="font-weight: bold; font-size: 0.9em;" id="sidebar-name">User</p>
                    <small style="cursor: pointer; color: var(--danger);" onclick="logout()">ƒêƒÉng xu·∫•t</small>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <section id="dashboard" class="tab-content active">
                <div class="header">
                    <div><h2 id="welcome-msg">üëã Hi, User!</h2></div>
                    <div><p id="clock" style="font-weight: bold;">00:00:00</p></div>
                </div>
                <div class="grid-box">
                    
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items: center;">
                            <h3>üé• Camera Tr·ª±c Ti·∫øp</h3>
                            <button onclick="toggleCam()" id="btn-cam" style="border:none; background:var(--primary-color); color:white; padding:5px 15px; border-radius:20px; cursor:pointer;">K·∫øt n·ªëi</button>
                        </div>
                        <div class="video-box">
                            <span class="live-tag" id="live-tag">üî¥ LIVE</span>
                            <img id="cam-img" src="https://images.unsplash.com/photo-1566633806327-68e1525a8479?q=80&w=1000&auto=format&fit=crop">
                            <video id="webcam-feed" class="hidden" autoplay playsinline muted></video>

                            <div class="camera-overlay">
                                <div class="overlay-row"><i class="fa-solid fa-location-dot"></i> <span id="cam-loc-label">ƒêang c·∫≠p nh·∫≠t...</span></div>
                                <div class="overlay-row"><i class="fa-solid fa-seedling"></i> <span>V∆∞·ªùn Hoa HPU2Süåº</span></div>
                                <div class="overlay-row"><i class="fa-regular fa-clock"></i> <span id="cam-time-label">00:00:00</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>üìù B√°o c√°o S·ª©c kh·ªèe</h3>
                        <div id="health-status" class="alert-box">
                            <i class="fa-solid fa-shield-check"></i> <span>Tr·∫°ng th√°i: ·ªîn ƒë·ªãnh</span>
                        </div>
                        <ul class="health-list">
                            <li><b>ü¶† B·ªánh ch·∫©n ƒëo√°n:</b> <span id="val-benh">Ch∆∞a ph√°t hi·ªán</span></li>
                            <li><b>‚ö†Ô∏è M·ª©c ƒë·ªô h·∫°i:</b> <span id="val-mucdo">0% (An to√†n)</span></li>
                            <li><b>üíä Thu·ªëc ƒë·ªÅ xu·∫•t:</b> <span id="val-thuoc">Vitamin B1 (D∆∞·ª°ng)</span></li>
                            <li><b>üíß Li·ªÅu l∆∞·ª£ng:</b> <span id="val-lieu">2ml / 1 l√≠t n∆∞·ªõc</span></li>
                            <li><b>‚è∞ Th·ªùi gian phun:</b> <span id="val-gio">17:30 Chi·ªÅu nay</span></li>
                        </ul>
                        <button onclick="triggerWarning()" style="width:100%; margin-top:20px; padding:12px; border:none; background:var(--danger); color:white; border-radius:15px; cursor:pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(255, 71, 87, 0.4);">
                            ‚ö†Ô∏è Test C·∫£nh B√°o
                        </button>
                    </div>
                </div>
            </section>

            <section id="settings" class="tab-content">
                <h2>‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng</h2>
                <div class="settings-grid">
                    <div class="profile-card-setting">
                        <div style="display:flex; align-items:center; gap:15px;">
                            <div class="setting-icon" style="margin:0;"><i class="fa-solid fa-user"></i></div>
                            <div>
                                <b id="info-name-box" style="display:block;">...</b>
                                <small id="info-contact-box" style="color:#888;">...</small> <br>
                                <small id="info-dob-box" style="color:#888;">...</small>
                            </div>
                        </div>
                        <button class="btn-edit-mini" onclick="openEditModal()"><i class="fa-solid fa-pen"></i> S·ª≠a</button>
                    </div>

                    <div class="setting-box">
                        <div class="setting-icon"><i class="fa-solid fa-palette"></i></div>
                        <span class="setting-label">M√†u n·ªÅn</span>
                        <div class="color-picker-wrapper">
                            <input type="color" value="#ffe3e8" onchange="changeColor(this.value)">
                        </div>
                    </div>

                    <div class="setting-box">
                        <div class="setting-icon"><i class="fa-solid fa-text-height"></i></div>
                        <span class="setting-label">C·ª° ch·ªØ</span>
                        <select class="genz-select" onchange="changeFontSize(this.value)">
                            <option value="font-medium">V·ª´a</option>
                            <option value="font-small">Nh·ªè</option>
                            <option value="font-large">L·ªõn</option>
                        </select>
                    </div>
                    
                    <div class="setting-box">
                        <div class="setting-icon"><i class="fa-solid fa-music"></i></div>
                        <span class="setting-label">Nh·∫°c chu√¥ng</span>
                        <select class="genz-select" id="ringtone-select">
                            <option value="siren">üö® C√≤i h√∫</option>
                            <option value="chill">üéµ Nh·∫°c Chill</option>
                            <option value="custom">üé§ File c·ªßa b·∫°n</option>
                        </select>
                        <input type="file" id="custom-file-input" accept="audio/*" style="display: none;" onchange="handleFileUpload(this)">
                        <button onclick="document.getElementById('custom-file-input').click()" style="margin-top:5px; border:1px dashed var(--primary-color); background:none; padding:3px 8px; border-radius:8px; font-size:0.7em; cursor:pointer;">üìÇ T·∫£i nh·∫°c</button>
                    </div>
                    
                    <div class="setting-box">
                        <div class="setting-icon"><i class="fa-solid fa-moon"></i></div>
                        <span class="setting-label">Ch·∫ø ƒë·ªô t·ªëi</span>
                        <input type="checkbox" class="genz-toggle" onchange="toggleTheme()">
                    </div>
                </div>
            </section>
            
            <section id="notifications" class="tab-content">
                 <h2>üîî Th√¥ng b√°o</h2>
                 <div class="card" style="margin-top:20px; text-align:center;"><p>Kh√¥ng c√≥ th√¥ng b√°o m·ªõi.</p></div>
            </section>
        </main>
    </div>

    <div id="edit-modal" class="hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color: var(--primary-color);">S·ª≠a Th√¥ng Tin</h3>
            <div class="input-group"><label>H·ªç t√™n</label><input type="text" id="edit-name" class="genz-input"></div>
            <div class="input-group"><label>SƒêT/Email</label><input type="text" id="edit-contact" class="genz-input"></div>
            <div class="input-group"><label>Ng√†y sinh</label><input type="date" id="edit-dob" class="genz-input"></div>
            <div style="display:flex; gap:10px; margin-top: 15px;">
                <button onclick="closeEditModal()" class="btn-submit" style="background:#ddd; color:#333;">H·ªßy</button>
                <button onclick="saveEditInfo()" class="btn-submit">L∆∞u l·∫°i</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ‚ö†Ô∏è D√ÅN M√É FIREBASE C·ª¶A B·∫†N V√ÄO ƒê√ÇY NH√â ‚ö†Ô∏è
        const firebaseConfig = { 
  apiKey : "AIzaSyAQSoG7YJbap3d47qqhEfZWc3kIJr35B5M" , 
  authDomain : "hpu2sfarm.firebaseapp.com" , 
  projectId : "hpu2sfarm" , 
  storageBucket : "hpu2sfarm.firebasestorage.app" , 
  messagingSenderId : "1028216215776" , 
  appId : "1:1028216215776:web:c324f55584da10b698d885" , 
  measurementId : "G-G3FH2ZNDJ0" 
};


        let app, auth, db;
        // Ki·ªÉm tra n·∫øu ch∆∞a nh·∫≠p config th√¨ d√πng ch·∫ø ƒë·ªô Offline (LocalStorage)
        try {
            if (firebaseConfig.apiKey) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (e) { console.log("Ch∆∞a c·∫•u h√¨nh Firebase, d√πng ch·∫ø ƒë·ªô Offline"); }

        // --- H√ÄM X·ª¨ L√ù AUTH (T·ª± ƒë·ªông ch·ªçn Firebase ho·∫∑c LocalStorage) ---
        window.handleRegister = async (e) => {
            e.preventDefault();
            const userData = {
                name: document.getElementById('reg-name').value,
                contact: document.getElementById('reg-contact').value, // SƒêT g·ªëc
                pass: document.getElementById('reg-pass').value,
                dob: document.getElementById('reg-dob').value,
                loc: document.getElementById('reg-loc').value,
                color: '#ffe3e8'
            };

            // Fix l·ªói email Firebase
            let emailAuth = userData.contact;
            if (!emailAuth.includes('@')) emailAuth += "@smartfarm.local";

            try {
                if (auth) { // N·∫øu c√≥ Firebase
                    document.querySelector('.btn-submit').innerText = "ƒêang t·∫°o...";
                    const cred = await createUserWithEmailAndPassword(auth, emailAuth, userData.pass);
                    await setDoc(doc(db, "users", cred.user.uid), { ...userData, emailAuth });
                } else { // N·∫øu d√πng Offline
                    localStorage.setItem('sfUser', JSON.stringify(userData));
                }
                alert("ƒêƒÉng k√Ω th√†nh c√¥ng!");
                window.toggleAuthMode('login');
            } catch (err) {
                let msg = err.message;
                if(msg.includes("email-already-in-use")) msg = "T√†i kho·∫£n ƒë√£ t·ªìn t·∫°i!";
                if(msg.includes("weak-password")) msg = "M·∫≠t kh·∫©u y·∫øu qu√° (c·∫ßn 6 k√Ω t·ª±)!";
                alert("L·ªói: " + msg);
            }
            document.querySelector('.btn-submit').innerText = "ƒêƒÉng K√Ω üöÄ";
        };

        window.handleLogin = async (e) => {
            e.preventDefault();
            const contact = document.getElementById('login-contact').value;
            const pass = document.getElementById('login-pass').value;
            let emailAuth = contact;
            if (!emailAuth.includes('@')) emailAuth += "@smartfarm.local";

            try {
                if (auth) {
                    document.querySelector('#login-form .btn-submit').innerText = "ƒêang v√†o...";
                    await signInWithEmailAndPassword(auth, emailAuth, pass);
                } else {
                    const user = JSON.parse(localStorage.getItem('sfUser'));
                    if (user && user.contact === contact && user.pass === pass) {
                        window.loginSuccess(user);
                    } else { alert("Sai th√¥ng tin!"); }
                }
            } catch (err) { alert("L·ªói ƒëƒÉng nh·∫≠p: " + err.message); }
            document.querySelector('#login-form .btn-submit').innerText = "V√†o Ngay üîì";
        };

        // Theo d√µi tr·∫°ng th√°i Firebase
        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) window.loginSuccess(docSnap.data());
                } else {
                    document.getElementById('auth-screen').style.display = 'flex';
                    document.getElementById('main-app').classList.remove('active');
                }
            });
        }

        window.loginSuccess = (user) => {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').classList.add('active');
            window.updateUI(user);
            if(user.color) window.changeColor(user.color, false);
        };

        window.updateUI = (user) => {
            document.getElementById('welcome-msg').innerText = `üëã Hi, ${user.name}!`;
            document.getElementById('sidebar-name').innerText = user.name;
            document.getElementById('sidebar-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=ff8fa3&color=fff`;
            document.getElementById('info-name-box').innerText = user.name;
            document.getElementById('info-contact-box').innerText = user.contact;
            document.getElementById('info-dob-box').innerText = "üéÇ " + user.dob;
            if(user.loc) document.getElementById('cam-loc-label').innerText = user.loc;
        };

        window.logout = () => { if(confirm("ƒêƒÉng xu·∫•t?")) { if(auth) signOut(auth); else location.reload(); } };

        // --- C√ÅC CH·ª®C NƒÇNG UI ---
        window.toggleAuthMode = (mode) => {
            document.getElementById('register-form').classList.toggle('hidden', mode === 'login');
            document.getElementById('login-form').classList.toggle('hidden', mode !== 'login');
        };
        window.switchTab = (tabId, el) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.menu li').forEach(l => l.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            el.classList.add('active');
        };
        
        // --- S·ª¨A TH√îNG TIN ---
        window.openEditModal = async () => {
            let user;
            if(auth && auth.currentUser) {
                const snap = await getDoc(doc(db, "users", auth.currentUser.uid));
                user = snap.data();
            } else { user = JSON.parse(localStorage.getItem('sfUser')); }
            
            if(user) {
                document.getElementById('edit-name').value = user.name;
                document.getElementById('edit-contact').value = user.contact;
                document.getElementById('edit-dob').value = user.dob;
                document.getElementById('edit-modal').classList.remove('hidden');
            }
        };
        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');
        
        window.saveEditInfo = async () => {
            const newData = {
                name: document.getElementById('edit-name').value,
                contact: document.getElementById('edit-contact').value,
                dob: document.getElementById('edit-dob').value
            };
            
            if(auth && auth.currentUser) {
                await updateDoc(doc(db, "users", auth.currentUser.uid), newData);
                const snap = await getDoc(doc(db, "users", auth.currentUser.uid)); // L·∫•y l·∫°i full data
                window.updateUI(snap.data());
            } else {
                let user = JSON.parse(localStorage.getItem('sfUser'));
                Object.assign(user, newData);
                localStorage.setItem('sfUser', JSON.stringify(user));
                window.updateUI(user);
            }
            window.closeEditModal();
            alert("ƒê√£ l∆∞u th√¥ng tin!");
        };

        // --- C√ÄI ƒê·∫∂T ---
        window.changeColor = async (color, save=true) => {
            document.documentElement.style.setProperty('--bg-color', color);
            if(save && auth && auth.currentUser) await updateDoc(doc(db, "users", auth.currentUser.uid), { color });
        };
        window.changeFontSize = (size) => {
            document.body.classList.remove('font-small', 'font-medium', 'font-large');
            document.body.classList.add(size);
        };
        window.toggleTheme = () => document.body.classList.toggle('dark-mode');
        window.autoGetLocation = () => {
            const icon = document.querySelector('.btn-loc-icon');
            icon.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    document.getElementById('reg-loc').value = `${pos.coords.latitude.toFixed(2)}, ${pos.coords.longitude.toFixed(2)}`;
                    icon.innerHTML = '<i class="fa-solid fa-check" style="color:green"></i>';
                },
                (err) => { alert("L·ªói v·ªã tr√≠: " + err.message); icon.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i>'; }
            );
        };

        // --- √ÇM THANH & C·∫¢NH B√ÅO ---
        let currentAudio = null;
        let customSoundURL = null;

        window.handleFileUpload = (input) => {
            const file = input.files[0];
            if (file) {
                customSoundURL = URL.createObjectURL(file);
                document.getElementById('ringtone-select').value = 'custom';
                alert("‚úÖ ƒê√£ t·∫£i file: " + file.name);
            }
        };

        window.triggerWarning = () => {
            // UI
            document.getElementById('health-status').className = "alert-box danger";
            document.getElementById('health-status').innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> <span>NGUY HI·ªÇM!</span>';
            document.getElementById('val-benh').innerText = "N·∫•m Ph·∫•n Tr·∫Øng"; document.getElementById('val-benh').style.color = "red";
            document.getElementById('val-mucdo').innerText = "85% (Cao)"; document.getElementById('val-mucdo').style.color = "red";
            document.getElementById('val-thuoc').innerText = "Nano B·∫°c / Sulfur";
            document.getElementById('val-lieu').innerText = "50ml / 16L n∆∞·ªõc";
            document.getElementById('val-gio').innerText = "Phun ngay l·∫≠p t·ª©c!";

            // Sound
            const soundType = document.getElementById('ringtone-select').value;
            let soundUrl = "";

            if (soundType === 'siren') {
                soundUrl = "https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.m4a";
            } else if (soundType === 'chill') {
                soundUrl = "https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.m4a";
            } else if (soundType === 'custom') {
                if (!customSoundURL) { alert("Ch∆∞a t·∫£i file nh·∫°c l√™n!"); return; }
                soundUrl = customSoundURL;
            }

            if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; }
            currentAudio = new Audio(soundUrl);
            currentAudio.play().catch(e => alert("ƒêi·ªán tho·∫°i ch·∫∑n t·ª± ph√°t. B·∫•m l·∫°i l·∫ßn n·ªØa!"));
        };

        // --- CAMERA ---
        window.toggleCam = async () => {
            const btn = document.getElementById('btn-cam');
            const img = document.getElementById('cam-img');
            const video = document.getElementById('webcam-feed');
            if(btn.innerText === "K·∫øt n·ªëi") {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    img.classList.add('hidden'); video.classList.remove('hidden'); 
                    document.querySelector('.live-tag').style.display = 'block';
                    btn.innerText = "Ng·∫Øt"; btn.style.background = "red";
                } catch (err) { alert("L·ªói Camera: " + err.message); }
            } else {
                if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
                video.srcObject = null;
                img.classList.remove('hidden'); video.classList.add('hidden');
                document.querySelector('.live-tag').style.display = 'none';
                btn.innerText = "K·∫øt n·ªëi"; btn.style.background = "var(--primary-color)";
            }
        };

        setInterval(()=>{
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString();
            if(document.getElementById('cam-time-label')) 
                document.getElementById('cam-time-label').innerText = now.toLocaleTimeString();
        },1000);
    </script>
</body>
</html>
