<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Farm HPU2S üå∑</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 1. C·∫§U H√åNH GIAO DI·ªÜN --- */
        :root {
            --primary-color: #ff8fa3; 
            --bg-color: #ffe3e8;      
            --glass-bg: rgba(255, 255, 255, 0.95);
            --text-color: #5d5d5d;
            --danger: #ff4757;
            --success: #2ed573;
            --base-font-size: 15px; 
            --bottom-nav-height: 70px;
        }

        body.dark-mode {
            --bg-color: #2f3640;
            --glass-bg: rgba(47, 54, 64, 0.95);
            --text-color: #f5f6fa;
            --primary-color: #a29bfe;
        }

        body.font-small { --base-font-size: 13px; }
        body.font-large { --base-font-size: 17px; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Quicksand', sans-serif; transition: all 0.3s; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            height: 100vh;
            color: var(--text-color);
            font-size: var(--base-font-size);
        }

        /* --- UI CHUNG --- */
        .genz-input {
            width: 100%; padding: 12px 15px; border-radius: 20px;
            border: 1px solid #ddd; background: #f9f9f9; outline: none; 
            font-size: var(--base-font-size); margin-top: 5px;
        }
        .genz-input:focus { border-color: var(--primary-color); background: white; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { font-size: 0.9em; font-weight: bold; margin-left: 10px; color: var(--primary-color); }
        .btn-submit { background: var(--primary-color); color: white; border: none; padding: 12px; width: 100%; border-radius: 50px; font-weight: bold; font-size: 1.1em; margin-top: 10px; cursor: pointer; }
        .hidden { display: none !important; }

        /* --- AUTH SCREEN --- */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; flex-direction: column; padding: 20px;
        }
        .auth-card {
            background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 30px;
            box-shadow: 0 10px 30px rgba(255, 143, 163, 0.3); text-align: center;
            width: 100%; max-width: 400px; border: 2px solid white; margin: auto;
        }
        .btn-link { background: none; border: none; color: var(--primary-color); text-decoration: underline; cursor: pointer; margin-top: 15px; }
        .location-wrapper { position: relative; }
        .btn-loc-icon { position: absolute; right: 10px; top: 55%; transform: translateY(-50%); background: none; border: none; color: var(--primary-color); font-size: 18px; padding: 5px; cursor: pointer;}

        /* --- DASHBOARD --- */
        #main-app { display: none; height: 100%; width: 100%; }
        #main-app.active { display: flex; }

        .sidebar {
            width: 260px; background: var(--glass-bg); padding: 20px;
            border-right: 1px solid rgba(255,255,255,0.5); display: flex; flex-direction: column;
            height: 100vh; position: sticky; top: 0;
        }
        .menu li {
            list-style: none; padding: 15px; margin: 10px 0; border-radius: 15px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px; white-space: nowrap;
        }
        .menu li.active, .menu li:hover { background: var(--primary-color); color: white; }
        .user-footer { margin-top: auto; display: flex; align-items: center; gap: 10px; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 15px; }

        .main-content { flex: 1; padding: 20px; overflow-y: auto; height: 100vh; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .grid-box { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        .card { background: var(--glass-bg); border-radius: 20px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }

        /* Camera & OSD */
        .video-box { height: 300px; background: #000; border-radius: 15px; position: relative; overflow: hidden; }
        .video-box video, .video-box img { width: 100%; height: 100%; object-fit: cover; }
        .live-tag { position: absolute; top: 15px; right: 15px; background: red; color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; display: none; font-weight: bold; animation: pulse 1.5s infinite; }
        
        /* OSD */
        .camera-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 15px; color: white;
            display: flex; flex-direction: column; gap: 5px;
            text-shadow: 1px 1px 2px black; font-size: 0.9em;
        }
        .overlay-row { display: flex; align-items: center; gap: 8px; }
        .overlay-row i { width: 20px; text-align: center; color: var(--primary-color); }
        
        /* B√°o c√°o */
        .alert-box { background: #dff9fb; color: #0abde3; padding: 15px; border-radius: 10px; margin-top: 10px; font-weight: bold; display: flex; align-items: center; gap: 10px;}
        .alert-box.danger { background: #ffdad9; color: #eb4d4b; border: 1px solid red; animation: shake 0.5s; }
        .health-list { list-style: none; margin-top: 15px; font-size: 0.95em; }
        .health-list li { margin-bottom: 8px; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 5px; display: flex; justify-content: space-between;}
        .health-list b { color: var(--text-color); }
        .health-list span { font-weight: bold; color: var(--primary-color); }

        /* Settings Grid */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-top: 15px; }
        .profile-card-setting { grid-column: 1 / -1; background: var(--glass-bg); border-radius: 20px; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .setting-box { background: var(--glass-bg); border-radius: 18px; padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .setting-box:hover { border-color: var(--primary-color); transform: translateY(-3px); }
        .setting-icon { font-size: 1.4em; color: var(--primary-color); background: rgba(255, 143, 163, 0.1); padding: 10px; border-radius: 50%; }
        .setting-label { font-size: 0.85em; font-weight: bold; margin-bottom: 2px; }
        .genz-select { padding: 4px; border-radius: 8px; border: 1px solid #ddd; width: 100%; text-align: center; font-size: 0.85em; }
        .genz-toggle { width: 18px; height: 18px; accent-color: var(--primary-color); cursor: pointer; }
        .color-picker-wrapper { width: 100%; height: 30px; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; cursor: pointer;}
        .color-picker-wrapper input { width: 150%; height: 150%; transform: translate(-10%, -10%); cursor: pointer; border: none; }
        .btn-edit-mini { background: #eee; border: none; padding: 5px 10px; border-radius: 10px; cursor: pointer; font-size: 0.8em; }

        /* Modal */
        #edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 25px; width: 90%; max-width: 350px; animation: zoomIn 0.3s; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
        @keyframes zoomIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            #main-app.active { flex-direction: column; }
            .sidebar {
                position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height);
                flex-direction: row; padding: 5px 15px; border-right: none;
                border-top: 1px solid rgba(255,255,255,0.5); z-index: 1000; justify-content: space-between; background: rgba(255, 255, 255, 0.98);
            }
            .sidebar h2, .user-footer { display: none; }
            .menu { display: flex; width: 100%; justify-content: space-around; padding: 0; }
            .menu li { flex-direction: column; padding: 8px 5px; margin: 0; font-size: 0.8em; gap: 5px; text-align: center; flex: 1; }
            .menu li i { font-size: 1.4em; }
            .main-content { padding: 15px; padding-bottom: calc(var(--bottom-nav-height) + 20px); height: auto; }
            .grid-box { grid-template-columns: 1fr; gap: 15px; }
            .settings-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body class="font-medium">

    <div id="auth-screen">
        <div id="register-form" class="auth-card">
            <h2 style="color: var(--primary-color);">üåª ƒêƒÉng K√Ω HPU2S Farm</h2>
            <form onsubmit="handleRegister(event)">
                <div class="input-group"><label>H·ªç v√† T√™n</label><input type="text" id="reg-name" class="genz-input" required></div>
                <div class="input-group"><label>SƒêT/Email</label><input type="text" id="reg-contact" class="genz-input" required></div>
                <div class="input-group"><label>M·∫≠t kh·∫©u</label><input type="password" id="reg-pass" class="genz-input" required></div>
                <div class="input-group"><label>Ng√†y sinh</label><input type="date" id="reg-dob" class="genz-input" required></div>
                <div class="input-group">
                    <label>V·ªã tr√≠ v∆∞·ªùn </label>
                    <div class="location-wrapper">
                        <input type="text" id="reg-loc" class="genz-input" placeholder="VD: V∆∞·ªùn S√¢n Th∆∞·ª£ng" required>
                        <button type="button" class="btn-loc-icon" onclick="autoGetLocation()"><i class="fa-solid fa-location-crosshairs"></i></button>
                    </div>
                </div>
                <button type="submit" class="btn-submit">ƒêƒÉng K√Ω ‚ú®</button>
                <button type="button" class="btn-link" onclick="toggleAuthMode('login')">ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</button>
            </form>
        </div>
        <div id="login-form" class="auth-card hidden">
            <h2 style="color: var(--primary-color);">üîê ƒêƒÉng Nh·∫≠p</h2>
            <form onsubmit="handleLogin(event)">
                <div class="input-group"><label>SƒêT/Email</label><input type="text" id="login-contact" class="genz-input" required></div>
                <div class="input-group"><label>M·∫≠t kh·∫©u</label><input type="password" id="login-pass" class="genz-input" required></div>
                <button type="submit" class="btn-submit">V√†o Ngay üîì</button>
                <button type="button" class="btn-link" onclick="toggleAuthMode('register')">ƒêƒÉng k√Ω m·ªõi</button>
            </form>
        </div>
    </div>

    <div id="main-app">
        <aside class="sidebar">
            <h2 style="text-align: center; color: var(--primary-color); margin-bottom: 20px;">üå± HPU2S Farm</h2>
            <ul class="menu">
                <li class="active" onclick="switchTab('dashboard', this)"><i class="fa-solid fa-chart-pie"></i> <span>T·ªïng quan</span></li>
                <li onclick="switchTab('notifications', this)"><i class="fa-solid fa-bell"></i> <span>Th√¥ng b√°o</span></li>
                <li onclick="switchTab('settings', this)"><i class="fa-solid fa-grid-2"></i> <span>C√†i ƒë·∫∑t</span></li>
            </ul>
            <div class="user-footer">
                <img src="" id="sidebar-avatar" style="width: 35px; border-radius: 50%;">
                <div style="overflow: hidden;">
                    <p style="font-weight: bold; font-size: 0.9em;" id="sidebar-name">User</p>
                    <small style="cursor: pointer; color: var(--danger);" onclick="logout()">ƒêƒÉng xu·∫•t</small>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <section id="dashboard" class="tab-content active">
                <div class="header">
                    <div><h2 id="welcome-msg">üëã Hi, User!</h2></div>
                    <div><p id="clock" style="font-weight: bold;">00:00:00</p></div>
                </div>
                <div class="grid-box">
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items: center;">
                            <h3>üé• Camera Tr·ª±c Ti·∫øp</h3>
                            <button onclick="toggleCam()" id="btn-cam" style="border:none; background:var(--primary-color); color:white; padding:5px 15px; border-radius:20px; cursor:pointer;">K·∫øt n·ªëi</button>
                        </div>
                        <div class="video-box">
                            <span class="live-tag" id="live-tag">üî¥ LIVE</span>
                            <img id="cam-img" src="https://images.unsplash.com/photo-1566633806327-68e1525a8479?q=80&w=1000&auto=format&fit=crop">
                            <video id="webcam-feed" class="hidden" autoplay playsinline muted></video>
                            <div class="camera-overlay">
                                <div class="overlay-row"><i class="fa-solid fa-location-dot"></i> <span id="cam-loc-label">ƒêang c·∫≠p nh·∫≠t...</span></div>
                                <div class="overlay-row"><i class="fa-solid fa-seedling"></i> <span>V∆∞·ªùn Hoa HPU2S üåº</span></div>
                                <div class="overlay-row"><i class="fa-regular fa-clock"></i> <span id="cam-time-label">00:00:00</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>üìù B√°o c√°o S·ª©c kh·ªèe</h3>
                        <div id="health-status" class="alert-box">
                            <i class="fa-solid fa-shield-check"></i> <span>Tr·∫°ng th√°i: ·ªîn ƒë·ªãnh</span>
                        </div>
                        <ul class="health-list">
                            <li><b>ü¶† B·ªánh ch·∫©n ƒëo√°n:</b> <span id="val-benh">Ch∆∞a ph√°t hi·ªán</span></li>
                            <li><b>‚ö†Ô∏è M·ª©c ƒë·ªô h·∫°i:</b> <span id="val-mucdo">0% (An to√†n)</span></li>
                            <li><b>üíä Thu·ªëc ƒë·ªÅ xu·∫•t:</b> <span id="val-thuoc">Vitamin B1 (D∆∞·ª°ng)</span></li>
                            <li><b>üíß Li·ªÅu l∆∞·ª£ng:</b> <span id="val-lieu">2ml / 1 l√≠t n∆∞·ªõc</span></li>
                            <li><b>‚è∞ Th·ªùi gian phun:</b> <span id="val-gio">17:30 Chi·ªÅu nay</span></li>
                        </ul>
                        <button onclick="triggerWarning()" style="width:100%; margin-top:20px; padding:12px; border:none; background:var(--danger); color:white; border-radius:15px; cursor:pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(255, 71, 87, 0.4);">
                            üõé Test C·∫£nh B√°o 
                        </button>
                    </div>
                </div>
            </section>

            <section id="settings" class="tab-content">
                <h2>‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng</h2>
                <div class="settings-grid">
                    <div class="profile-card-setting">
                        <div style="display:flex; align-items:center; gap:15px;">
                            <div class="setting-icon" style="margin:0;"><i class="fa-solid fa-user"></i></div>
                            <div>
                                <b id="info-name-box" style="display:block;">...</b>
                                <small id="info-contact-box" style="color:#888;">...</small> <br>
                                <small id="info-dob-box" style="color:#888;">...</small>
                            </div>
                        </div>
                        <button class="btn-edit-mini" onclick="openEditModal()"><i class="fa-solid fa-pen"></i> S·ª≠a</button>
                    </div>
                    <div class="setting-box">
                        <div class="setting-icon"><i class="fa-solid fa-palette"></i></div>
                        <span class="setting-label">M√†u n·ªÅn</span>
                        <div class="color-picker-wrapper">
                            <input type="color" value="#ffe3e8" onchange="changeColor(this.value)">
                        </div>
                    </div>
                    <div class="setting-box">
                        <div class="setting-icon"><i class="fa-solid fa-text-height"></i></div>
                        <span class="setting-label">C·ª° ch·ªØ</span>
                        <select class="genz-select" onchange="changeFontSize(this.value)">
                            <option value="font-medium">V·ª´a</option>
                            <option value="font-small">Nh·ªè</option>
                            <option value="font-large">L·ªõn</option>
                        </select>
                    </div>
                    <div class="setting-box">
                        <div class="setting-icon"><i class="fa-solid fa-music"></i></div>
                        <span class="setting-label">Nh·∫°c chu√¥ng</span>
                        <select class="genz-select" id="ringtone-select">
                            <option value="siren">üö® C√≤i h√∫</option>
                            <option value="chill">üéµ Nh·∫°c Th∆∞ Gi√£n</option>
                        </select>
                    </div>
                    <div class="setting-box">
                        <div class="setting-icon"><i class="fa-solid fa-moon"></i></div>
                        <span class="setting-label">Ch·∫ø ƒë·ªô t·ªëi</span>
                        <input type="checkbox" class="genz-toggle" onchange="toggleTheme()">
                    </div>
                </div>
            </section>
            
            <section id="notifications" class="tab-content">
                 <h2>üîî Th√¥ng b√°o</h2>
                 <div class="card" style="margin-top:20px; text-align:center;"><p>Kh√¥ng c√≥ th√¥ng b√°o m·ªõi.</p></div>
            </section>
        </main>
    </div>

    <div id="edit-modal" class="hidden">
        <div class="modal-content">
            <h3 style="text-align:center; color: var(--primary-color);">S·ª≠a Th√¥ng Tin</h3>
            <div class="input-group"><label>H·ªç t√™n</label><input type="text" id="edit-name" class="genz-input"></div>
            <div class="input-group"><label>SƒêT/Email</label><input type="text" id="edit-contact" class="genz-input"></div>
            <div class="input-group"><label>Ng√†y sinh</label><input type="date" id="edit-dob" class="genz-input"></div>
            <div style="display:flex; gap:10px; margin-top: 15px;">
                <button onclick="closeEditModal()" class="btn-submit" style="background:#ddd; color:#333;">H·ªßy</button>
                <button onclick="saveEditInfo()" class="btn-submit">L∆∞u l·∫°i</button>
            </div>
        </div>
    </div>

   <script type="module">
    // Import c√°c h√†m c·∫ßn thi·∫øt t·ª´ Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 2. C·∫§U H√åNH FIREBASE (D√ÅN CODE B·∫†N COPY ·ªû B∆Ø·ªöC 1 V√ÄO ƒê√ÇY) 
    // -----------------------------------------------------------
      const firebaseConfig = {
        apiKey: "AIzaSyAQSoG7YJbap3d47qqhEfZWc3kIJr35B5M",
        authDomain: "hpu2sfarm.firebaseapp.com",
        projectId: "hpu2sfarm",
        storageBucket: "hpu2sfarm.firebasestorage.app",
        messagingSenderId: "1028216215776",
        appId: "1:1028216215776:web:c324f55584da10b698d885",
        measurementId: "G-G3FH2ZNDJ0"
      };
    // -----------------------------------------------------------

    // Kh·ªüi t·∫°o
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- BI·∫æN TO√ÄN C·ª§C CHO UI ---
    window.toggleAuthMode = (mode) => {
        document.getElementById('register-form').classList.toggle('hidden', mode === 'login');
        document.getElementById('login-form').classList.toggle('hidden', mode !== 'login');
    };

    // --- 3. X·ª¨ L√ù ƒêƒÇNG K√ù (L∆ØU L√äN M√ÇY) ---
    window.handleRegister = async (e) => {
        e.preventDefault();
        const email = document.getElementById('reg-contact').value; // D√πng l√†m email ƒëƒÉng nh·∫≠p
        const pass = document.getElementById('reg-pass').value;
        const name = document.getElementById('reg-name').value;
        const dob = document.getElementById('reg-dob').value;
        const loc = document.getElementById('reg-loc').value;
        const btn = document.querySelector('#register-form .btn-submit');

        try {
            btn.innerText = "ƒêang t·∫°o t√†i kho·∫£n...";
            // 1. T·∫°o t√†i kho·∫£n Auth
            const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
            const user = userCredential.user;

            // 2. L∆∞u th√¥ng tin ph·ª• (T√™n, ng√†y sinh, v·ªã tr√≠) v√†o Firestore Database
            await setDoc(doc(db, "users", user.uid), {
                name: name,
                dob: dob,
                loc: loc,
                email: email,
                color: '#ffe3e8' // M√†u m·∫∑c ƒë·ªãnh
            });

            alert("ƒêƒÉng k√Ω th√†nh c√¥ng! ƒêang v√†o...");
            // Kh√¥ng c·∫ßn chuy·ªÉn trang th·ªß c√¥ng, onAuthStateChanged s·∫Ω t·ª± lo
        } catch (error) {
            alert("L·ªói: " + error.message);
            btn.innerText = "ƒêƒÉng K√Ω üöÄ";
        }
    };

    // --- 4. X·ª¨ L√ù ƒêƒÇNG NH·∫¨P ---
    window.handleLogin = async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-contact').value;
        const pass = document.getElementById('login-pass').value;
        const btn = document.querySelector('#login-form .btn-submit');

        try {
            btn.innerText = "ƒêang ki·ªÉm tra...";
            await signInWithEmailAndPassword(auth, email, pass);
            // Th√†nh c√¥ng -> onAuthStateChanged s·∫Ω ch·∫°y
        } catch (error) {
            alert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + error.message);
            btn.innerText = "V√†o Ngay üîì";
        }
    };

    // --- 5. THEO D√ïI TR·∫†NG TH√ÅI NG∆Ø·ªúI D√ôNG (T·ª∞ ƒê·ªòNG) ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // -> ƒê√£ ƒëƒÉng nh·∫≠p
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').classList.add('active');
            
            // L·∫•y d·ªØ li·ªáu chi ti·∫øt t·ª´ Database v·ªÅ
            const docRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const userData = docSnap.data();
                updateUI(userData);
                if(userData.color) changeColor(userData.color, false);
            }
        } else {
            // -> Ch∆∞a ƒëƒÉng nh·∫≠p
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('main-app').classList.remove('active');
        }
    });

    // --- 6. C√ÅC H√ÄM UI/LOGIC KH√ÅC (GI·ªÆ NGUY√äN LOGIC C≈®) ---
    
    function updateUI(user) {
        document.getElementById('welcome-msg').innerText = `üëã Hi, ${user.name}!`;
        document.getElementById('sidebar-name').innerText = user.name;
        document.getElementById('sidebar-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=ff8fa3&color=fff`;
        document.getElementById('info-name-box').innerText = user.name;
        document.getElementById('info-contact-box').innerText = user.email;
        document.getElementById('info-dob-box').innerText = "üéÇ " + user.dob;
        if(user.loc) document.getElementById('cam-loc-label').innerText = user.loc;
    }

    window.logout = () => {
        if(confirm("ƒêƒÉng xu·∫•t?")) signOut(auth);
    };

    // S·ª¨A TH√îNG TIN (L∆∞u l√™n Database)
    window.openEditModal = async () => {
        const user = auth.currentUser;
        if(user) {
            const docSnap = await getDoc(doc(db, "users", user.uid));
            const data = docSnap.data();
            document.getElementById('edit-name').value = data.name;
            document.getElementById('edit-contact').value = data.email;
            document.getElementById('edit-dob').value = data.dob;
            document.getElementById('edit-modal').classList.remove('hidden');
        }
    };

    window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

    window.saveEditInfo = async () => {
        const user = auth.currentUser;
        if(user) {
            const newName = document.getElementById('edit-name').value;
            const newDob = document.getElementById('edit-dob').value;
            
            // C·∫≠p nh·∫≠t l√™n Database
            await updateDoc(doc(db, "users", user.uid), {
                name: newName,
                dob: newDob
            });
            
            // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c (gi·∫£ l·∫≠p ƒë·ªÉ ƒë·ª° ph·∫£i load l·∫°i)
            document.getElementById('info-name-box').innerText = newName;
            document.getElementById('info-dob-box').innerText = "üéÇ " + newDob;
            
            window.closeEditModal();
            alert("ƒê√£ c·∫≠p nh·∫≠t l√™n m√¢y! ‚òÅÔ∏è");
        }
    };

    // ƒê·ªîI M√ÄU (L∆∞u l√™n Database)
    window.changeColor = async (color, save=true) => {
        document.documentElement.style.setProperty('--bg-color', color);
        if(save && auth.currentUser) {
            await updateDoc(doc(db, "users", auth.currentUser.uid), { color: color });
        }
    };

    // C√ÅC H√ÄM C∆† B·∫¢N KH√ÅC (Copy l·∫°i t·ª´ b·∫£n c≈©)
    window.autoGetLocation = () => {
        const icon = document.querySelector('.btn-loc-icon');
        icon.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                document.getElementById('reg-loc').value = `${pos.coords.latitude.toFixed(2)}, ${pos.coords.longitude.toFixed(2)}`;
                icon.innerHTML = '<i class="fa-solid fa-check" style="color:green"></i>';
            },
            (err) => { alert("L·ªói v·ªã tr√≠: " + err.message); icon.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i>'; }
        );
    };

    window.switchTab = (tabId, el) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.menu li').forEach(l => l.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        el.classList.add('active');
    }

    window.changeFontSize = (size) => {
        document.body.classList.remove('font-small', 'font-medium', 'font-large');
        document.body.classList.add(size);
    }
    
    window.toggleTheme = () => document.body.classList.toggle('dark-mode');

    // Camera & Sound (Gi·ªØ nguy√™n logic b·∫£n V3)
    let currentAudio = null;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // ... (D√°n l·∫°i h√†m playSiren, playChill, triggerWarning, toggleCam t·ª´ b·∫£n tr∆∞·ªõc v√†o ƒë√¢y ho·∫∑c vi·∫øt l·∫°i ng·∫Øn g·ªçn)
    // ƒê·ªÉ code g·ªçn, m√¨nh vi·∫øt l·∫°i ph·∫ßn k√≠ch ho·∫°t n√∫t ·ªü ƒë√¢y:
    
    window.triggerWarning = () => {
        document.getElementById('health-status').className = "alert-box danger";
        document.getElementById('health-status').innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> <span>NGUY HI·ªÇM: N·∫•m b·ªánh!</span>';
        // ... (C·∫≠p nh·∫≠t text b·ªánh nh∆∞ c≈©) ...
        
        const soundType = document.getElementById('ringtone-select').value;
        if(soundType === 'siren') alert("Gi·∫£ l·∫≠p ti·∫øng C√≤i h√∫ (Web Audio API)"); 
        else alert("Gi·∫£ l·∫≠p nh·∫°c Chill");
        // B·∫°n copy l·∫°i h√†m √¢m thanh x·ªãn ·ªü c√¢u tr·∫£ l·ªùi tr∆∞·ªõc v√†o ƒë√¢y nh√©!
    };

    window.toggleCam = async () => {
        const btn = document.getElementById('btn-cam');
        const img = document.getElementById('cam-img');
        const video = document.getElementById('webcam-feed');
        if(btn.innerText === "K·∫øt n·ªëi") {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                img.classList.add('hidden'); video.classList.remove('hidden'); 
                document.querySelector('.live-tag').style.display = 'block';
                btn.innerText = "Ng·∫Øt"; btn.style.background = "red";
            } catch (err) { alert("L·ªói Camera: " + err.message); }
        } else {
            // T·∫Øt
            video.srcObject.getTracks().forEach(t => t.stop());
            img.classList.remove('hidden'); video.classList.add('hidden');
            document.querySelector('.live-tag').style.display = 'none';
            btn.innerText = "K·∫øt n·ªëi"; btn.style.background = "var(--primary-color)";
        }
    };

    setInterval(()=>{
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString();
        const camTime = document.getElementById('cam-time-label');
        if(camTime) camTime.innerText = now.toLocaleTimeString();
    },1000);

</script>
</body>
</html>
